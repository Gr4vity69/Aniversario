<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda del Tesoro</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
            overscroll-behavior: contain;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        #main {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .wheel-container {
            position: relative;
            width: 340px;
            height: 340px;
            margin: 40px auto 20px auto;
        }
        .wheel-svg {
            width: 100%;
            height: 100%;
        }
        .option-label {
            position: absolute;
            width: 120px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-size: 1.1em;
            pointer-events: none;
            font-weight: bold;
            text-shadow: 0 0 8px #000;
            transition: transform 0.15s, background 0.15s, box-shadow 0.15s;
            z-index: 5;
        }
        .option-label.active {
            background: #1abc9c;
            color: #fff;
            border-radius: 20px;
            box-shadow: 0 0 20px #1abc9c88;
            transform: translate(-50%, -50%) scale(1.18);
        }
        .arrow {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%) rotate(0deg);
            z-index: 2;
            pointer-events: none;
        }
        .center-circle {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80px;
            height: 80px;
            background: #222;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            box-shadow: 0 0 20px #000a;
        }
        .center-circle-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-size: 1em;
            text-align: center;
            z-index: 4;
            pointer-events: none;
        }
        .question-media {
            display: block;
            margin: 20px auto;
            max-width: 90%;
            max-height: 200px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
<div id="main">
<h1 id="title"></h1>
    <div id="content"></div>
</div>
<script>
let config;
let currentQuestion = 0;
let gameOver = false;
let questions = [];
let audios = {};

function polarToCartesian(cx, cy, r, angle) {
    let rad = (angle-90) * Math.PI / 180;
    return {
        x: cx + r * Math.cos(rad),
        y: cy + r * Math.sin(rad)
    };
}

function drawWheel(options, selectedIdx = null, errorIdx = null) {
    const n = options.length;
    const svgNS = 'http://www.w3.org/2000/svg';
    const size = 340, cx = 170, cy = 170, r1 = 80, r2 = 160;
    let svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('class', 'wheel-svg');
    svg.setAttribute('width', size);
    svg.setAttribute('height', size);
    for (let i = 0; i < n; i++) {
        let startAngle = (360/n)*i;
        let endAngle = (360/n)*(i+1);
        let p1 = polarToCartesian(cx, cy, r1, startAngle);
        let p2 = polarToCartesian(cx, cy, r2, startAngle);
        let p3 = polarToCartesian(cx, cy, r2, endAngle);
        let p4 = polarToCartesian(cx, cy, r1, endAngle);
        let d = `M${p1.x},${p1.y} L${p2.x},${p2.y} A${r2},${r2} 0 0,1 ${p3.x},${p3.y} L${p4.x},${p4.y} A${r1},${r1} 0 0,0 ${p1.x},${p1.y} Z`;
        let path = document.createElementNS(svgNS, 'path');
        path.setAttribute('d', d);
        if (selectedIdx === i) {
            path.setAttribute('fill', '#1abc9c');
            path.setAttribute('filter', 'drop-shadow(0 0 16px #1abc9c)');
        } else if (errorIdx === i) {
            path.setAttribute('fill', '#c0392b');
            path.setAttribute('filter', 'drop-shadow(0 0 16px #c0392b)');
        } else {
            path.setAttribute('fill', '#333');
            path.removeAttribute('filter');
        }
        path.setAttribute('stroke', '#fff');
        path.setAttribute('stroke-width', '2');
        svg.appendChild(path);
    }
    return svg;
}


function showQuestion(idx) {
    if (gameOver) return;
    currentQuestion = idx;
    const c = document.getElementById('content');
    c.innerHTML = '';
    if (idx >= questions.length) {
        showWinScreen();
        if (audios.music) audios.music.pause();
        return;
    }
    const q = questions[idx];
    let h2 = document.createElement('h2');
    h2.textContent = q.text;
    c.appendChild(h2);
    if (q.media) {
        let ext = q.media.split('.').pop();
        if (['mp4','webm','ogg'].includes(ext)) {
            let v = document.createElement('video');
            v.src = q.media;
            v.controls = true;
            v.className = 'question-media';
            c.appendChild(v);
        } else if (['mp3','wav','ogg'].includes(ext)) {
            let a = document.createElement('audio');
            a.src = q.media;
            a.controls = true;
            a.className = 'question-media';
            c.appendChild(a);
        }
    }
    // Rueda Mass Effect mejorada
    let wheelContainer = document.createElement('div');
    wheelContainer.className = 'wheel-container';
    let svg = drawWheel(q.options);
    wheelContainer.appendChild(svg);
    // Etiquetas
    const n = q.options.length;
    let optionLabels = [];
    for (let i = 0; i < n; i++) {
        let angle = (360/n)*i + 180/n;
        let pos = polarToCartesian(170, 170, 200, angle);
        let label = document.createElement('div');
        label.className = 'option-label';
        label.style.left = `${pos.x}px`;
        label.style.top = `${pos.y}px`;
        label.textContent = q.options[i];
        wheelContainer.appendChild(label);
        optionLabels.push(label);
    }
    // Flecha
    let arrow = document.createElement('img');
    arrow.src = 'data:image/svg+xml;utf8,<svg width="40" height="40" xmlns="http://www.w3.org/2000/svg"><polygon points="20,5 35,35 20,28 5,35" fill="white"/></svg>';
    arrow.className = 'arrow';
    wheelContainer.appendChild(arrow);
    // Círculo central
    let center = document.createElement('div');
    center.className = 'center-circle';
    wheelContainer.appendChild(center);
    let centerText = document.createElement('div');
    centerText.className = 'center-circle-text';
    centerText.textContent = 'Arrastra desde aquí';
    wheelContainer.appendChild(centerText);

    // Drag logic mejorado (touch y mouse)
    let dragging = false, startX, startY, lastActive = null;
    function getAngle(x, y) {
        let dx = x - startX;
        let dy = y - startY;
        let angle = Math.atan2(dy, dx) * 180 / Math.PI;
        if (angle < 0) angle += 360;
        return angle;
    }
    function getOptionIdx(angle) {
        return Math.floor((angle + 360/n/2) % 360 / (360/n));
    }
    let currentSelectedIdx = null;
    function highlightOption(idx) {
        // Ilumina la porción del círculo
        let svg2 = drawWheel(q.options, idx);
        wheelContainer.replaceChild(svg2, svg);
        svg = svg2;
        currentSelectedIdx = idx;
    }
    function clearHighlight() {
        let svg2 = drawWheel(q.options);
        wheelContainer.replaceChild(svg2, svg);
        svg = svg2;
        currentSelectedIdx = null;
    }
    // Touch events
    center.addEventListener('touchstart', function(e) {
        dragging = true;
        let t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
        e.preventDefault();
    }, {passive: false});
    document.addEventListener('touchmove', function(e) {
        if (!dragging) return;
        let t = e.touches[0];
        let angle = getAngle(t.clientX, t.clientY);
        arrow.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
        let dx = t.clientX - startX, dy = t.clientY - startY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 60) {
            let idx = getOptionIdx(angle);
            highlightOption(idx);
            lastActive = idx;
        } else {
            clearHighlight();
            lastActive = null;
        }
        e.preventDefault();
    }, {passive: false});
    document.addEventListener('touchend', function(e) {
        if (!dragging) return;
        dragging = false;
        let t = e.changedTouches[0];
        let dx = t.clientX - startX, dy = t.clientY - startY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 60 || lastActive === null) { clearHighlight(); return; }
        let idx = lastActive;
        clearHighlight();
        // Feedback visual
        if (parseInt(q.correct) === idx) {
            let svg2 = drawWheel(q.options, idx);
            wheelContainer.replaceChild(svg2, svg);
            svg = svg2;
            playAudio('select');
            setTimeout(() => {
                playAudio('correct');
                if (currentQuestion === questions.length - 1) {
                    showWinScreen();
                    gameOver = true;
                } else {
                    showFeedback('correct', currentQuestion);
                }
            }, 400);
        } else {
            let svg2 = drawWheel(q.options, null, idx);
            wheelContainer.replaceChild(svg2, svg);
            svg = svg2;
            playAudio('wrong');
            showLoseScreen();
            gameOver = true;
        }
        e.preventDefault();
    }, {passive: false});
    // Mouse events (PC)
    center.addEventListener('mousedown', function(e) {
        dragging = true;
        startX = e.clientX;
        startY = e.clientY;
        e.preventDefault();
    });
    document.addEventListener('mousemove', function(e) {
        if (!dragging) return;
        let angle = getAngle(e.clientX, e.clientY);
        arrow.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
        let dx = e.clientX - startX, dy = e.clientY - startY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > 60) {
            let idx = getOptionIdx(angle);
            highlightOption(idx);
            lastActive = idx;
        } else {
            clearHighlight();
            lastActive = null;
        }
    });
    document.addEventListener('mouseup', function(e) {
        if (!dragging) return;
        dragging = false;
        let dx = e.clientX - startX, dy = e.clientY - startY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 60 || lastActive === null) { clearHighlight(); return; }
        let idx = lastActive;
        clearHighlight();
        // Feedback visual
        if (parseInt(q.correct) === idx) {
            let svg2 = drawWheel(q.options, idx);
            wheelContainer.replaceChild(svg2, svg);
            svg = svg2;
            playAudio('select');
            setTimeout(() => {
                playAudio('correct');
                if (currentQuestion === questions.length - 1) {
                    showWinScreen();
                    gameOver = true;
                } else {
                    showFeedback('correct', currentQuestion);
                }
            }, 400);
        } else {
            let svg2 = drawWheel(q.options, null, idx);
            wheelContainer.replaceChild(svg2, svg);
            svg = svg2;
            playAudio('wrong');
            showLoseScreen();
            gameOver = true;
        }
    });
    c.appendChild(wheelContainer);
}

// Mostrar feedback multimedia y animaciones solo para respuestas correctas intermedias
function showFeedback(type, idx) {
    if (type === 'correct') {
        const c = document.getElementById('content');
        let msg = config.correctMessage || '¡Respuesta correcta!';
        let media = config.correctMedia;
        let audio = config.correctAudio;
        let anim = config.correctAnim;
        let emojis = config.correctEmojis;
        let div = document.createElement('div');
        div.style.textAlign = 'center';
        div.style.margin = '20px 0';
        div.innerHTML = `<h3 style="color:#1abc9c">${msg}</h3>`;
        c.appendChild(div);
        if (media) {
            let ext = media.split('.').pop();
            if (['mp4','webm','ogg'].includes(ext)) {
                let v = document.createElement('video');
                v.src = media;
                v.autoplay = true;
                v.loop = false;
                v.controls = true;
                v.className = 'question-media';
                c.appendChild(v);
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                let img = document.createElement('img');
                img.src = media;
                img.className = 'question-media';
                c.appendChild(img);
            }
        }
        if (audio) {
            let a = new Audio(audio);
            a.play();
        }
        if (anim && anim !== 'none') {
            setTimeout(()=>triggerAnimation(anim, emojis), 50);
        }
        setTimeout(() => {
            showQuestion(idx+1);
        }, 1200);
    }
}

// Pantalla de derrota personalizada
function showLoseScreen() {
    const c = document.getElementById('content');
    c.innerHTML = '';
    let msg = config.loseMessage || '¡Has perdido!';
    let media = config.loseMedia;
    let audio = config.loseAudio;
    let anim = config.loseAnim;
    let emojis = config.loseEmojis;
    let div = document.createElement('div');
    div.style.textAlign = 'center';
    div.style.margin = '20px 0';
    div.innerHTML = `<h2 style="color:#e74c3c">${msg}</h2>`;
    c.appendChild(div);
    if (media) {
        let ext = media.split('.').pop();
        if (['mp4','webm','ogg'].includes(ext)) {
            let v = document.createElement('video');
            v.src = media;
            v.autoplay = true;
            v.loop = true;
            v.controls = true;
            v.className = 'question-media';
            c.appendChild(v);
        } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
            let img = document.createElement('img');
            img.src = media;
            img.className = 'question-media';
            c.appendChild(img);
        }
    }
    if (audio) {
        let a = new Audio(audio);
        a.play();
    }
    if (anim && anim !== 'none') {
        triggerAnimation(anim, emojis);
    }
}

// Pantalla de victoria personalizada
function showWinScreen() {
    const c = document.getElementById('content');
    c.innerHTML = '';
    let msg = config.winMessage || '¡Felicidades! Has terminado la búsqueda 🎉';
    let media = config.winMedia;
    let audio = config.winAudio;
    let anim = config.winAnim;
    let emojis = config.winEmojis;
    let div = document.createElement('div');
    div.style.textAlign = 'center';
    div.style.margin = '20px 0';
    div.innerHTML = `<h2 style="color:#ffd700">${msg}</h2>`;
    c.appendChild(div);
    if (media) {
        let ext = media.split('.').pop();
        if (['mp4','webm','ogg'].includes(ext)) {
            let v = document.createElement('video');
            v.src = media;
            v.autoplay = true;
            v.loop = true;
            v.controls = true;
            v.className = 'question-media';
            c.appendChild(v);
        } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
            let img = document.createElement('img');
            img.src = media;
            img.className = 'question-media';
            c.appendChild(img);
        }
    }
    if (audio) {
        let a = new Audio(audio);
        a.play();
    }
    if (anim && anim !== 'none') {
        triggerAnimation(anim, emojis);
    }
}

// Animaciones y partículas/emojis
function triggerAnimation(anim, emojis) {
    if (anim === 'confetti') {
        confettiEffect();
    } else if (anim === 'emojis' || anim === 'custom') {
        emojiEffect(emojis);
    } else if (anim === 'explosion') {
        explosionEffect();
    } else if (anim === 'shake') {
        document.body.classList.add('shake');
        setTimeout(()=>document.body.classList.remove('shake'), 700);
    }
}

// Efecto confetti simple
function confettiEffect() {
    for (let i=0; i<40; i++) {
        let conf = document.createElement('div');
        conf.textContent = '🎉';
        conf.style.position = 'fixed';
        conf.style.left = Math.random()*100+'vw';
        conf.style.top = '-40px';
        conf.style.fontSize = (24+Math.random()*16)+'px';
        conf.style.opacity = 0.8;
        conf.style.transition = 'top 1.2s cubic-bezier(.4,2,.6,1), opacity 1.2s';
        document.body.appendChild(conf);
        setTimeout(()=>{
            conf.style.top = (60+Math.random()*30)+'vh';
            conf.style.opacity = 0;
        }, 10);
        setTimeout(()=>conf.remove(), 1300);
    }
}
// Efecto emojis personalizados
function emojiEffect(emojis) {
    let arr = [];
    if (typeof emojis === 'string') {
        arr = emojis.split(',').map(e=>e.trim()).filter(Boolean);
    }
    if (!arr || arr.length === 0) {
        // Mostrar puntos brillantes si no hay emojis
        for (let i=0; i<24; i++) {
            let dot = document.createElement('div');
            dot.textContent = '';
            dot.style.position = 'fixed';
            dot.style.left = Math.random()*100+'vw';
            dot.style.top = '-40px';
            dot.style.width = dot.style.height = (16+Math.random()*12)+'px';
            dot.style.borderRadius = '50%';
            let color = (window.config && window.config.particleColor) ? window.config.particleColor : '#fffbe6';
            dot.style.background = color;
            dot.style.boxShadow = `0 0 16px 4px ${color}`;
            dot.style.opacity = 0.85;
            dot.style.transition = 'top 1.2s cubic-bezier(.4,2,.6,1), opacity 1.2s';
            document.body.appendChild(dot);
            setTimeout(()=>{
                dot.style.top = (60+Math.random()*30)+'vh';
                dot.style.opacity = 0;
            }, 10);
            setTimeout(()=>dot.remove(), 1300);
        }
    } else {
        for (let i=0; i<24; i++) {
            let em = document.createElement('div');
            em.textContent = arr[Math.floor(Math.random()*arr.length)];
            em.style.position = 'fixed';
            em.style.left = Math.random()*100+'vw';
            em.style.top = '-40px';
            em.style.fontSize = (28+Math.random()*18)+'px';
            em.style.opacity = 0.9;
            em.style.transition = 'top 1.2s cubic-bezier(.4,2,.6,1), opacity 1.2s';
            document.body.appendChild(em);
            setTimeout(()=>{
                em.style.top = (60+Math.random()*30)+'vh';
                em.style.opacity = 0;
            }, 10);
            setTimeout(()=>em.remove(), 1300);
        }
    }
}
// Efecto explosión
function explosionEffect() {
    for (let i=0; i<30; i++) {
        let part = document.createElement('div');
        part.textContent = '💥';
        part.style.position = 'fixed';
        part.style.left = '50vw';
        part.style.top = '50vh';
        part.style.fontSize = (20+Math.random()*20)+'px';
        part.style.opacity = 0.9;
        part.style.transform = `translate(-50%,-50%) rotate(${Math.random()*360}deg)`;
        part.style.transition = 'left 0.8s, top 0.8s, opacity 0.8s';
        document.body.appendChild(part);
        setTimeout(()=>{
            part.style.left = (40+Math.random()*20)+'vw';
            part.style.top = (30+Math.random()*40)+'vh';
            part.style.opacity = 0;
        }, 10);
        setTimeout(()=>part.remove(), 900);
    }
}

function playAudio(key) {
    if (audios[key]) {
        audios[key].currentTime = 0;
        audios[key].play();
    }
}

async function loadConfig() {
    const url = window.location.pathname;
    const parts = url.split('/');
    const gameId = parts[2];
    const res = await fetch(`/api/game/${gameId}/config`);
    config = await res.json();
    // Título personalizado
    document.getElementById('title').textContent = config.title || 'Búsqueda del Tesoro';
    document.title = config.title || 'Búsqueda del Tesoro';
    // Colores y fondo
    document.body.style.background = config.bgType === 'color' ? config.bgColor : '#111';
    document.body.style.color = config.textColor || '#fff';
    if (config.bgType === 'image' && config.bgFile) {
        document.body.style.background = `url('${config.bgFile}') center/cover no-repeat`;
    } else if (config.bgType === 'video' && config.bgFile) {
        let v = document.createElement('video');
        v.src = config.bgFile;
        v.autoplay = true;
        v.loop = true;
        v.muted = true;
        v.style.position = 'fixed';
        v.style.top = 0;
        v.style.left = 0;
        v.style.width = '100vw';
        v.style.height = '100vh';
        v.style.objectFit = 'cover';
        v.style.zIndex = '-1';
        document.body.appendChild(v);
    }
    // Audios
    if (config.music) {
        audios.music = new Audio(config.music);
        audios.music.loop = true;
        audios.music.volume = 0.5;
        audios.music.play();
    }
    if (config.soundSelect) audios.select = new Audio(config.soundSelect);
    if (config.soundCorrect) audios.correct = new Audio(config.soundCorrect);
    if (config.soundWrong) audios.wrong = new Audio(config.soundWrong);
    // Preguntas
    questions = config.questions.map((q, i) => ({
        text: q.text,
        options: q.options,
        correct: q.correct,
        media: config.mediaQuestions && config.mediaQuestions[i] ? config.mediaQuestions[i] : null
    }));
    // Intentos máximos configurables
    maxAttempts = parseInt(config.maxAttempts) || 1;
    attempts = 0;
    gameOver = false;
    currentQuestion = 0;
    showQuestion(0);
}

window.onload = loadConfig;
</script>
    currentQuestion = idx;
    const c = document.getElementById('content');
    c.innerHTML = '';
    // Mostrar mensaje intermedio si corresponde
    let showedIntermediate = false;
    if (config && config.intermediates && Array.isArray(config.intermediates)) {
        for (const interm of config.intermediates) {
            if (interm && interm.insertAt === idx) {
                let div = document.createElement('div');
                div.style.textAlign = 'center';
                div.style.margin = '20px 0';
                div.innerHTML = `<h3 style='color:#6cf'>${interm.text || ''}</h3>`;
                c.appendChild(div);
                if (interm.media) {
                    let ext = interm.media.split('.').pop();
                    if (['mp4','webm','ogg'].includes(ext)) {
                        let v = document.createElement('video');
                        v.src = interm.media;
                        v.controls = true;
                        v.className = 'question-media';
                        c.appendChild(v);
                    } else if (['mp3','wav','ogg'].includes(ext)) {
                        let a = document.createElement('audio');
                        a.src = interm.media;
                        a.controls = true;
                        a.className = 'question-media';
                        c.appendChild(a);
                    }
                }
                showedIntermediate = true;
            }
        }
    }
    if (showedIntermediate) {
        // Esperar 1.2s y mostrar la pregunta
        setTimeout(() => showQuestion(idx), 1200);
        return;
    }
    if (idx >= questions.length) {
        showWinScreen();
        if (audios.music) audios.music.pause();
        return;
    }
    const q = questions[idx];
    let h2 = document.createElement('h2');
    h2.textContent = q.text;
    c.appendChild(h2);
    if (q.media) {
        let ext = q.media.split('.').pop();
        if (['mp4','webm','ogg'].includes(ext)) {
            let v = document.createElement('video');
            v.src = q.media;
            v.controls = true;
            v.className = 'question-media';
            c.appendChild(v);
        } else if (['mp3','wav','ogg'].includes(ext)) {
            let a = document.createElement('audio');
            a.src = q.media;
            a.controls = true;
            a.className = 'question-media';
            c.appendChild(a);
        }
    }
    // ...existing code for wheel, drag logic, etc...
