<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda del Tesoro</title>
    <style>
        /* Estilos optimizados y corregidos */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: #111;
            color: #fff;
            overscroll-behavior: contain;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            overflow-x: hidden;
        }
        #main {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        .wheel-container {
            position: relative;
            width: 340px;
            height: 340px;
            margin: 40px auto 20px auto;
        }
        .wheel-svg {
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-out;
        }
        .option-label {
            position: absolute;
            width: 120px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            font-size: 1.1em;
            pointer-events: none;
            font-weight: bold;
            text-shadow: 0 0 8px #000;
            transition: all 0.15s;
            z-index: 5;
            padding: 5px;
            border-radius: 12px;
        }
        .option-label.active {
            background: #1abc9c;
            color: #fff;
            box-shadow: 0 0 20px #1abc9c88;
            transform: translate(-50%, -50%) scale(1.18);
        }
        .arrow {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%) rotate(0deg);
            z-index: 2;
            pointer-events: none;
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.7));
        }
        .center-circle {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80px;
            height: 80px;
            background: #222;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            box-shadow: 0 0 20px #000a, inset 0 0 10px rgba(0,0,0,0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .center-circle-text {
            color: #aaa;
            font-size: 0.9em;
            text-align: center;
            pointer-events: none;
        }
        .question-media {
            display: block;
            margin: 20px auto;
            max-width: 90%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .hidden { display: none; }
        .shake {
            animation: shake 0.7s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }
        
        #mute-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            z-index: 1000;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        /* Pantallas de estado */
        .screen {
            text-align: center;
            padding: 25px;
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            padding: 12px 25px;
            background: linear-gradient(to right, #007bff, #0062cc);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin: 20px auto;
            display: block;
            width: 200px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .attempts-counter {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(4px);
        }
        
        /* Overlay de mensajes intermedios */
        .intermediate-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.4s;
        }
        .intermediate-content {
            background: rgba(40,40,50,0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(100,100,255,0.2);
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1em;
        }

        /* Efectos de partículas */
        .particle {
            position: fixed;
            z-index: 10000;
            pointer-events: none;
            animation: particleFloat 1.2s ease-out forwards;
        }
        @keyframes particleFloat {
            to {
                opacity: 0;
                transform: translateY(-100px) rotate(360deg);
            }
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .wheel-container {
                width: 90vw;
                height: 90vw;
                max-width: 300px;
                max-height: 300px;
            }
            .option-label {
                font-size: 0.9em;
                width: 100px;
            }
            h2 {
                font-size: 1.3em;
            }
            .btn {
                width: 180px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
<div id="main">
    <button id="mute-btn">🔊</button>
    <h1 id="title"></h1>
    <div id="content"></div>
</div>
<script>
    // Sistema mejorado de estado del juego
    const GameState = {
        START: 'start',
        PLAYING: 'playing',
        WIN: 'win',
        LOSE: 'lose'
    };
    
    let config;
    let currentQuestion = 0;
    let gameState = GameState.START;
    let questions = [];
    let audios = {};
    let maxAttempts = 1;
    let attempts = 0;
    let muted = false;
    let currentGameAttempts = 0;

    // Función mejorada para coordenadas polares
    function polarToCartesian(cx, cy, r, angle) {
        const rad = (angle - 90) * Math.PI / 180;
        return {
            x: cx + r * Math.cos(rad),
            y: cy + r * Math.sin(rad)
        };
    }

    // Rueda mejorada con gradientes y sombras
    function drawWheel(options, selectedIdx = null, errorIdx = null) {
        const n = options.length;
        const svgNS = 'http://www.w3.org/2000/svg';
        const size = 340, cx = 170, cy = 170, r1 = 80, r2 = 160;
        let svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('class', 'wheel-svg');
        svg.setAttribute('width', size);
        svg.setAttribute('height', size);
        
        // Fondo de la rueda
        const bgCircle = document.createElementNS(svgNS, 'circle');
        bgCircle.setAttribute('cx', cx);
        bgCircle.setAttribute('cy', cy);
        bgCircle.setAttribute('r', r2 + 5);
        bgCircle.setAttribute('fill', '#222');
        bgCircle.setAttribute('filter', 'url(#shadow)');
        svg.appendChild(bgCircle);
        
        // Definición de sombra
        const defs = document.createElementNS(svgNS, 'defs');
        const filter = document.createElementNS(svgNS, 'filter');
        filter.setAttribute('id', 'shadow');
        filter.setAttribute('x', '-20%');
        filter.setAttribute('y', '-20%');
        filter.setAttribute('width', '140%');
        filter.setAttribute('height', '140%');
        
        const feDropShadow = document.createElementNS(svgNS, 'feDropShadow');
        feDropShadow.setAttribute('dx', '0');
        feDropShadow.setAttribute('dy', '5');
        feDropShadow.setAttribute('stdDeviation', '5');
        feDropShadow.setAttribute('flood-color', 'rgba(0,0,0,0.5)');
        
        filter.appendChild(feDropShadow);
        defs.appendChild(filter);
        svg.appendChild(defs);
        
        for (let i = 0; i < n; i++) {
            const startAngle = (360 / n) * i;
            const endAngle = (360 / n) * (i + 1);
            const p1 = polarToCartesian(cx, cy, r1, startAngle);
            const p2 = polarToCartesian(cx, cy, r2, startAngle);
            const p3 = polarToCartesian(cx, cy, r2, endAngle);
            const p4 = polarToCartesian(cx, cy, r1, endAngle);
            
            const d = `M${p1.x},${p1.y} L${p2.x},${p2.y} A${r2},${r2} 0 0,1 ${p3.x},${p3.y} L${p4.x},${p4.y} A${r1},${r1} 0 0,0 ${p1.x},${p1.y} Z`;
            
            const path = document.createElementNS(svgNS, 'path');
            path.setAttribute('d', d);
            
            // Colores con gradientes
            const color = i % 2 === 0 ? '#2c3e50' : '#34495e';
            const highlight = selectedIdx === i ? '#1abc9c' : errorIdx === i ? '#e74c3c' : color;
            
            path.setAttribute('fill', highlight);
            path.setAttribute('stroke', 'rgba(255,255,255,0.1)');
            path.setAttribute('stroke-width', '1');
            
            if (selectedIdx === i) {
                path.setAttribute('filter', 'url(#glow)');
            }
            
            svg.appendChild(path);
        }
        
        return svg;
    }

    // Pantalla de inicio mejorada
    function showStartScreen() {
        clearContent();
        const c = document.getElementById('content');
        
        const startDiv = document.createElement('div');
        startDiv.className = 'screen';
        startDiv.innerHTML = `
            <div style="margin-bottom: 30px;">
                <h2>${config.title || 'Búsqueda del Tesoro'}</h2>
                <p style="color: #aaa; max-width: 80%; margin: 0 auto;">Responde correctamente todas las preguntas para descubrir el tesoro</p>
            </div>
            <div style="margin-top: 30px;">
                <button id="start-btn" class="btn">¡Comenzar Aventura!</button>
            </div>
        `;
        
        if (config.bgType === 'video') {
            startDiv.style.background = 'rgba(0,0,0,0.6)';
            startDiv.style.borderRadius = '20px';
            startDiv.style.padding = '40px 20px';
            startDiv.style.backdropFilter = 'blur(5px)';
        }
        
        c.appendChild(startDiv);
        document.getElementById('start-btn').addEventListener('click', startGame);
    }

    // Inicio del juego con reset de estado
    function startGame() {
        currentQuestion = 0;
        attempts = 0;
        currentGameAttempts = 0;
        gameState = GameState.PLAYING;
        showQuestion(0);
    }

    // Función para mostrar preguntas con manejo de errores
    function showQuestion(idx) {
        if (gameState !== GameState.PLAYING) return;
        
        // Manejar mensajes intermedios primero
        if (config.intermediates && config.intermediates.length > 0) {
            const intermediate = config.intermediates.find(i => i.insertAt === idx);
            if (intermediate) {
                showIntermediateMessage(intermediate, idx);
                return;
            }
        }
        
        // Verificar fin del juego
        if (idx >= questions.length) {
            showWinScreen();
            if (audios.music) audios.music.pause();
            return;
        }
        
        clearContent();
        updateAttemptsCounter();
        
        const q = questions[idx];
        const c = document.getElementById('content');
        
        // Cabecera de pregunta
        const header = document.createElement('div');
        header.style.marginBottom = '20px';
        header.innerHTML = `
            <h2 style="margin-bottom: 10px;">${q.text}</h2>
            ${currentGameAttempts > 0 ? `<p style="color: #ff6b6b;">Intentos restantes: ${maxAttempts - currentGameAttempts}</p>` : ''}
        `;
        c.appendChild(header);
        
        // Media de pregunta
        if (q.media) {
            const ext = q.media.split('.').pop();
            let mediaElement;
            
            if (['mp4','webm','ogg'].includes(ext)) {
                mediaElement = document.createElement('video');
                mediaElement.src = q.media;
                mediaElement.controls = true;
                mediaElement.autoplay = true;
                mediaElement.playsInline = true;
            } else if (['mp3','wav','ogg'].includes(ext)) {
                mediaElement = document.createElement('audio');
                mediaElement.src = q.media;
                mediaElement.controls = true;
                mediaElement.autoplay = true;
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                mediaElement = document.createElement('img');
                mediaElement.src = q.media;
            }
            
            if (mediaElement) {
                mediaElement.className = 'question-media';
                c.appendChild(mediaElement);
            }
        }
        
        // Contenedor de la rueda
        const wheelContainer = document.createElement('div');
        wheelContainer.className = 'wheel-container';
        
        // Crear rueda
        const svg = drawWheel(q.options);
        wheelContainer.appendChild(svg);
        
        // Etiquetas de opciones
        const n = q.options.length;
        for (let i = 0; i < n; i++) {
            const angle = (360 / n) * i + 180 / n;
            const pos = polarToCartesian(170, 170, 120, angle);
            
            const label = document.createElement('div');
            label.className = 'option-label';
            label.textContent = q.options[i];
            label.style.left = `${pos.x}px`;
            label.style.top = `${pos.y}px`;
            wheelContainer.appendChild(label);
        }
        
        // Flecha central
        const arrow = document.createElement('img');
        arrow.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>';
        arrow.className = 'arrow';
        wheelContainer.appendChild(arrow);
        
        // Círculo central interactivo
        const center = document.createElement('div');
        center.className = 'center-circle';
        
        const centerText = document.createElement('div');
        centerText.className = 'center-circle-text';
        centerText.textContent = 'Arrastra para responder';
        center.appendChild(centerText);
        wheelContainer.appendChild(center);
        
        // Lógica de arrastre mejorada
        let dragging = false;
        let startX, startY;
        let lastActive = null;
        
        function getAngle(x, y) {
            const dx = x - startX;
            const dy = y - startY;
            let angle = Math.atan2(dy, dx) * 180 / Math.PI;
            return angle < 0 ? angle + 360 : angle;
        }
        
        function getOptionIdx(angle) {
            return Math.floor((angle + 360 / n / 2) % 360 / (360 / n));
        }
        
        function highlightOption(idx) {
            const newSvg = drawWheel(q.options, idx);
            wheelContainer.replaceChild(newSvg, svg);
            wheelContainer.querySelectorAll('.option-label').forEach((label, i) => {
                label.classList.toggle('active', i === idx);
            });
        }
        
        function handleStart(e) {
            dragging = true;
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            e.preventDefault();
        }
        
        function handleMove(e) {
            if (!dragging) return;
            
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const angle = getAngle(clientX, clientY);
            
            arrow.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist > 60) {
                const idx = getOptionIdx(angle);
                highlightOption(idx);
                lastActive = idx;
            } else {
                wheelContainer.querySelectorAll('.option-label').forEach(label => {
                    label.classList.remove('active');
                });
                lastActive = null;
            }
        }
        
        function handleEnd(e) {
            if (!dragging) return;
            dragging = false;
            
            const clientX = e.clientX || e.changedTouches[0].clientX;
            const clientY = e.clientY || e.changedTouches[0].clientY;
            const dx = clientX - startX;
            const dy = clientY - startY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist < 60 || lastActive === null) {
                wheelContainer.querySelectorAll('.option-label').forEach(label => {
                    label.classList.remove('active');
                });
                return;
            }
            
            const selectedIdx = lastActive;
            if (parseInt(q.correct) === selectedIdx) {
                // Respuesta correcta
                playAudio('correct');
                attempts = 0;
                currentGameAttempts = 0;
                updateAttemptsCounter();
                
                setTimeout(() => {
                    if (currentQuestion === questions.length - 1) {
                        showWinScreen();
                    } else {
                        showFeedback('correct', currentQuestion);
                    }
                }, 600);
            } else {
                // Respuesta incorrecta
                playAudio('wrong');
                currentGameAttempts++;
                attempts++;
                updateAttemptsCounter();
                
                if (currentGameAttempts >= maxAttempts) {
                    showLoseScreen();
                } else {
                    showFeedback('wrong', currentQuestion);
                }
            }
        }
        
        // Eventos mejorados para touch y mouse
        center.addEventListener('mousedown', handleStart);
        center.addEventListener('touchstart', handleStart, { passive: false });
        
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('touchmove', handleMove, { passive: false });
        
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);
        
        c.appendChild(wheelContainer);
    }

    // Mensajes intermedios con botón de cierre
    function showIntermediateMessage(intermediate, questionIdx) {
        const overlay = document.createElement('div');
        overlay.className = 'intermediate-overlay';
        
        const content = document.createElement('div');
        content.className = 'intermediate-content';
        
        if (intermediate.text) {
            const text = document.createElement('h2');
            text.style.color = '#6cf';
            text.style.marginBottom = '20px';
            text.textContent = intermediate.text;
            content.appendChild(text);
        }
        
        if (intermediate.media) {
            const ext = intermediate.media.split('.').pop();
            let mediaElement;
            
            if (['mp4','webm','ogg'].includes(ext)) {
                mediaElement = document.createElement('video');
                mediaElement.src = intermediate.media;
                mediaElement.controls = true;
                mediaElement.autoplay = true;
                mediaElement.loop = false;
                mediaElement.className = 'question-media';
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                mediaElement = document.createElement('img');
                mediaElement.src = intermediate.media;
                mediaElement.className = 'question-media';
            } else if (['mp3','wav','ogg'].includes(ext)) {
                mediaElement = document.createElement('audio');
                mediaElement.src = intermediate.media;
                mediaElement.controls = true;
                mediaElement.className = 'question-media';
            }
            
            if (mediaElement) content.appendChild(mediaElement);
        }
        
        const closeButton = document.createElement('button');
        closeButton.className = 'close-btn';
        closeButton.textContent = '✕';
        closeButton.addEventListener('click', () => {
            overlay.remove();
            showQuestion(questionIdx);
        });
        content.appendChild(closeButton);
        
        overlay.appendChild(content);
        document.body.appendChild(overlay);
    }

    // Feedback visual mejorado
    function showFeedback(type, idx) {
        clearContent();
        const c = document.getElementById('content');
        
        let configData, color, icon;
        if (type === 'correct') {
            configData = {
                msg: config.correctMessage || '¡Respuesta correcta!',
                media: config.correctMedia,
                audio: config.correctAudio,
                anim: config.correctAnim,
                emojis: config.correctEmojis
            };
            color = '#1abc9c';
            icon = '✓';
        } else {
            configData = {
                msg: config.wrongMessage || 'Respuesta incorrecta. ¡Intenta de nuevo!',
                media: config.wrongMedia,
                audio: config.wrongAudio,
                anim: config.wrongAnim,
                emojis: config.wrongEmojis
            };
            color = '#e74c3c';
            icon = '✗';
        }
        
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'screen';
        feedbackDiv.innerHTML = `
            <div style="font-size: 4em; margin-bottom: 20px; color: ${color};">${icon}</div>
            <h3 style="color: ${color};">${configData.msg}</h3>
        `;
        
        if (configData.media) {
            const ext = configData.media.split('.').pop();
            let mediaElement;
            
            if (['mp4','webm','ogg'].includes(ext)) {
                mediaElement = document.createElement('video');
                mediaElement.src = configData.media;
                mediaElement.autoplay = true;
                mediaElement.loop = false;
                mediaElement.controls = false;
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                mediaElement = document.createElement('img');
                mediaElement.src = configData.media;
            }
            
            if (mediaElement) {
                mediaElement.className = 'question-media';
                mediaElement.style.margin = '20px auto';
                feedbackDiv.appendChild(mediaElement);
            }
        }
        
        c.appendChild(feedbackDiv);
        
        if (configData.audio) {
            const audio = createAudio(configData.audio);
            audio.play();
        }
        
        if (configData.anim && configData.anim !== 'none') {
            triggerAnimation(configData.anim, configData.emojis);
        }
        
        setTimeout(() => {
            if (type === 'correct') {
                currentQuestion++;
                showQuestion(currentQuestion);
            } else {
                showQuestion(currentQuestion);
            }
        }, 2000);
    }

    // Pantalla de victoria mejorada
    function showWinScreen() {
        gameState = GameState.WIN;
        clearContent();
        const c = document.getElementById('content');
        
        const winDiv = document.createElement('div');
        winDiv.className = 'screen';
        winDiv.innerHTML = `
            <div style="font-size: 4em; margin-bottom: 20px;">🏆</div>
            <h2 style="color: #ffd700;">${config.winMessage || '¡Felicidades! Has completado la búsqueda'}</h2>
        `;
        
        if (config.winMedia) {
            const ext = config.winMedia.split('.').pop();
            let mediaElement;
            
            if (['mp4','webm','ogg'].includes(ext)) {
                mediaElement = document.createElement('video');
                mediaElement.src = config.winMedia;
                mediaElement.autoplay = true;
                mediaElement.loop = true;
                mediaElement.controls = false;
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                mediaElement = document.createElement('img');
                mediaElement.src = config.winMedia;
            }
            
            if (mediaElement) {
                mediaElement.className = 'question-media';
                winDiv.appendChild(mediaElement);
            }
        }
        
        const replayButton = document.createElement('button');
        replayButton.className = 'btn';
        replayButton.textContent = 'Jugar de nuevo';
        replayButton.addEventListener('click', () => {
            location.reload();
        });
        winDiv.appendChild(replayButton);
        
        c.appendChild(winDiv);
        
        if (config.winAudio) {
            const audio = createAudio(config.winAudio);
            audio.play();
        }
        
        if (config.winAnim && config.winAnim !== 'none') {
            triggerAnimation(config.winAnim, config.winEmojis);
        }
    }

    // Pantalla de derrota mejorada
    function showLoseScreen() {
        gameState = GameState.LOSE;
        clearContent();
        const c = document.getElementById('content');
        
        const loseDiv = document.createElement('div');
        loseDiv.className = 'screen';
        loseDiv.innerHTML = `
            <div style="font-size: 4em; margin-bottom: 20px;">💔</div>
            <h2 style="color: #e74c3c;">${config.loseMessage || '¡Has perdido! Intenta de nuevo'}</h2>
        `;
        
        if (config.loseMedia) {
            const ext = config.loseMedia.split('.').pop();
            let mediaElement;
            
            if (['mp4','webm','ogg'].includes(ext)) {
                mediaElement = document.createElement('video');
                mediaElement.src = config.loseMedia;
                mediaElement.autoplay = true;
                mediaElement.loop = true;
                mediaElement.controls = false;
            } else if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                mediaElement = document.createElement('img');
                mediaElement.src = config.loseMedia;
            }
            
            if (mediaElement) {
                mediaElement.className = 'question-media';
                loseDiv.appendChild(mediaElement);
            }
        }
        
        const retryButton = document.createElement('button');
        retryButton.className = 'btn';
        retryButton.textContent = 'Reintentar';
        retryButton.addEventListener('click', () => {
            location.reload();
        });
        loseDiv.appendChild(retryButton);
        
        c.appendChild(loseDiv);
        
        if (config.loseAudio) {
            const audio = createAudio(config.loseAudio);
            audio.play();
        }
        
        if (config.loseAnim && config.loseAnim !== 'none') {
            triggerAnimation(config.loseAnim, config.loseEmojis);
        }
    }

    // Sistema de partículas mejorado
    function triggerAnimation(anim, emojis) {
        if (anim === 'confetti') {
            confettiEffect();
        } else if (anim === 'emojis' || anim === 'custom') {
            emojiEffect(emojis);
        } else if (anim === 'explosion') {
            explosionEffect();
        } else if (anim === 'shake') {
            document.body.classList.add('shake');
            setTimeout(() => {
                document.body.classList.remove('shake');
            }, 700);
        }
    }

    function confettiEffect() {
        const colors = ['#ff6b6b', '#48dbfb', '#1dd1a1', '#feca57', '#ff9ff3'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'particle';
                confetti.innerHTML = '🎉';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '100vh';
                confetti.style.fontSize = (20 + Math.random() * 20) + 'px';
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 1200);
            }, i * 30);
        }
    }

    function emojiEffect(emojis) {
        const emojiArray = emojis ? 
            emojis.split(',').map(e => e.trim()).filter(Boolean) : 
            ['✨', '⭐', '💖'];
        
        for (let i = 0; i < 25; i++) {
            setTimeout(() => {
                const emoji = document.createElement('div');
                emoji.className = 'particle';
                emoji.textContent = emojiArray[Math.floor(Math.random() * emojiArray.length)];
                emoji.style.left = Math.random() * 100 + 'vw';
                emoji.style.top = '100vh';
                emoji.style.fontSize = (24 + Math.random() * 24) + 'px';
                
                document.body.appendChild(emoji);
                
                setTimeout(() => {
                    emoji.remove();
                }, 1200);
            }, i * 50);
        }
    }

    function explosionEffect() {
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = '💥';
            particle.style.left = '50vw';
            particle.style.top = '50vh';
            particle.style.fontSize = (20 + Math.random() * 30) + 'px';
            particle.style.transform = `translate(-50%, -50%) rotate(${Math.random() * 360}deg)`;
            
            document.body.appendChild(particle);
            
            setTimeout(() => {
                particle.style.left = (30 + Math.random() * 40) + 'vw';
                particle.style.top = (20 + Math.random() * 60) + 'vh';
                particle.style.opacity = '0';
            }, 10);
            
            setTimeout(() => {
                particle.remove();
            }, 800);
        }
    }

    // Funciones auxiliares mejoradas
    function createAudio(src) {
        const audio = new Audio(src);
        audio.preload = 'auto';
        audio.volume = muted ? 0 : 0.7;
        return audio;
    }

    function playAudio(key) {
        if (audios[key] && !muted) {
            audios[key].currentTime = 0;
            audios[key].play();
        }
    }

    function clearContent() {
        const c = document.getElementById('content');
        c.innerHTML = '';
    }

    function updateAttemptsCounter() {
        const counter = document.querySelector('.attempts-counter');
        if (counter) counter.remove();
        
        if (gameState === GameState.PLAYING && maxAttempts > 1) {
            const counter = document.createElement('div');
            counter.className = 'attempts-counter';
            counter.textContent = `Intentos: ${currentGameAttempts}/${maxAttempts}`;
            document.getElementById('main').appendChild(counter);
        }
    }

    // Carga de configuración mejorada
    async function loadConfig() {
        const url = window.location.pathname;
        const gameId = url.split('/')[2];
        
        try {
            const res = await fetch(`/api/game/${gameId}/config`);
            if (!res.ok) throw new Error('Error loading config');
            
            config = await res.json();
            
            // Título dinámico
            document.getElementById('title').textContent = config.title || 'Búsqueda del Tesoro';
            document.title = config.title || 'Búsqueda del Tesoro';
            
            // Estilos dinámicos
            document.body.style.background = config.bgType === 'color' ? config.bgColor : '#111';
            document.body.style.color = config.textColor || '#fff';
            
            // Fondo avanzado
            if (config.bgType === 'image' && config.bgFile) {
                document.body.style.backgroundImage = `url('${config.bgFile}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
            } else if (config.bgType === 'video' && config.bgFile) {
                const video = document.createElement('video');
                video.src = config.bgFile;
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                video.style.position = 'fixed';
                video.style.top = '0';
                video.style.left = '0';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                video.style.zIndex = '-1';
                document.body.appendChild(video);
            }
            
            // Sistema de audio
            const loadAudio = (key, file) => {
                if (file) audios[key] = createAudio(file);
            };
            
            loadAudio('music', config.music);
            loadAudio('select', config.soundSelect);
            loadAudio('correct', config.soundCorrect);
            loadAudio('wrong', config.soundWrong);
            
            if (audios.music) {
                audios.music.loop = true;
                audios.music.volume = 0.5;
                audios.music.play();
            }
            
            // Preguntas e intermedios
            questions = config.questions || [];
            config.intermediates = config.intermediates || [];
            
            // Intentos
            maxAttempts = parseInt(config.maxAttempts) || 1;
            currentGameAttempts = 0;
            
            // Botón de mute
            document.getElementById('mute-btn').addEventListener('click', function() {
                muted = !muted;
                this.textContent = muted ? '🔇' : '🔊';
                if (audios.music) audios.music.muted = muted;
            });
            
            showStartScreen();
        } catch (err) {
            console.error('Error loading game config:', err);
            document.getElementById('content').innerHTML = `
                <div class="screen">
                    <h2 style="color: #e74c3c;">Error al cargar el juego</h2>
                    <p>${err.message}</p>
                    <button class="btn" onclick="location.reload()">Reintentar</button>
                </div>
            `;
        }
    }

    // Inicialización
    window.onload = loadConfig;
</script>
</body>
</html>